<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>MLBot</title>
	<style>
		body > * {
			/*display: none;*/
			position: fixed;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
		}

		#contacts {
			display: flex;
			flex-direction: column;
		}

		#contacts ul {
			overflow-y: scroll;
			height: calc(100vh - 40px);
		}

		#contacts .fill {
			display: flex;
		}

		#contacts form {
			display: flex;
			flex-direction: column;
		}

		.online {
			background-color: rgba(0, 128, 0, 0.2);
		}
	</style>
</head>
<body>
<form style="display: none">
	<h1>Войдите</h1>
	<input name="email" type="email"/>
	<input name="password" type="password"/>
	<button type="submit">Войти</button>
</form>
<div id="contacts" style="display: none">
	<input type="search"/>
	<div>
		<button id="checkAll" type="button">все</button>
		<button id="checkNobody" type="button">никого</button>
		<button id="checkOnline" type="button">онлайн</button>
		<button id="checkOffline" type="button">офлайн</button>
		<label id="showOnline">
			<input type="checkbox"/>
			только онлайн
		</label>
	</div>
	<div class="fill">
		<ul></ul>
		<form>
			<div>
				Загрузка контактов
				<input id="loadContacts" type="file"/>
				<div id="loadContactsInformer" style="display: none">
					<span class="actual"></span>
					из
					<span class="expected"></span>
				</div>
			</div>
			<textarea></textarea>
			<button id="send" type="button">Послать</button>
		</form>
	</div>
</div>
<script>
	const {extend, each, debounce} = require('lodash')
	const EventEmitter = require('events')
	const Skype = require('skyweb')

	function $$(selector) {
		return document.querySelector(selector)
	}

	function $all(selector) {
		return document.querySelectorAll(selector)
	}

	function $id(id) {
		return document.getElementById(id)
	}

	function bar(events) {
		each(events, function (fn, id) {
			$id(id).addEventListener('click', fn)
		})
	}

	['map', 'forEach'].forEach(function (fn) {
		NodeList.prototype[fn] = Array.prototype[fn]
		HTMLFormControlsCollection.prototype[fn] = Array.prototype[fn]
	})

	extend(Element.prototype, {
		show() {
			this.style.display = 'block'
			return this
		},

		hide() {
			this.style.display = 'none'
			return this
		},

		attach() {
			if (this._parent) {
				if (this._nextSibling) {
					this._parent.insertBefore(this, this._nextSibling)
					delete this._nextSibling
				}
				else {
					this._parent.appendChild(this)
				}
				delete this._parent
			}
			else {
				console.error('Parent not defined')
			}
		},

		detach() {
			this._parent = this.parentNode
			const nextSibling = this.nextSibling
			if (nextSibling) {
				this._nextSibling = nextSibling
			}
			this.remove()
		},

		append(array) {
			const fragment = document.createDocumentFragment()
			array.forEach(function (element) {
				fragment.appendChild(element)
			})
			this.appendChild(fragment)
		}
	})

	Object.defineProperties(Element.prototype, {
		isVisible: {
			get() {
				return 'none' === this.style.display
			},

			set(value) {
				this.style.display = value ? 'block' : 'none'
			}
		}
	})

	extend(HTMLFormElement.prototype, EventEmitter.prototype)
	extend(HTMLFormElement.prototype, {
		init(events) {
			EventEmitter.call(this)
			each(events, (fn, name) => this.on(name, fn))
			this.addEventListener('submit', (e) => {
				e.preventDefault()
				this.emit('submit', this.toJSON())
			})
			return this
		},

		toJSON() {
			const object = {}
			this.elements.forEach(function (input) {
				if (input.hasAttribute('name')) {
					object[input.getAttribute('name')] = input.value
				}
			})
			return object
		}
	})

	const loginForm = $$('form').init({
		submit(data) {
			console.log(data)
		}
	})
	//			.show()

	function $new(tag, attributes, children) {
		if (!children && attributes instanceof Array || attributes instanceof Element) {
			children = attributes
			attributes = null
		}
		const element = document.createElement(tag)
		if ('string' === typeof attributes) {
			element.setAttribute('class', attributes)
		}
		else {
			each(attributes, function (value, name) {
				if ('boolean' === typeof value) {
					element[name] = value
				}
				else {
					element.setAttribute(name, value)
				}
			})
		}
		if ('string' === typeof children) {
			element.innerHTML = children
		}
		else if (children instanceof Element) {
			element.appendChild(children)
		}
		else {
			each(children, function (child) {
				element.appendChild(child)
			})
		}
		return element
	}

	const skype = new Skype()
	const {accept, multi, send} = require('./skapi')(skype)

	skype.login('viktor.anatolievi4', 'lbpfqywtrhenj!!!')
			.then(function (account) {

				skype.contactsService.loadContacts(account, function (_1, contacts) {
					$$('#contacts ul').append(contacts.map(contact => {
						const li = $new('li', {
							class: contact.authorized ? 'online' : 'offline',
							id: contact.id
						}, [
							$new('input', {type: 'checkbox', checked: contact.authorized}),
							$new('span', null, contact.display_name)
						])
						li.model = contact
						return li
					}))

					bar({
						checkAll() {
							$all('#contacts li').forEach(function (li) {
								li.querySelector('[type=checkbox]').checked = true
							})
						},

						checkNobody() {
							$all('#contacts li').forEach(function (li) {
								li.querySelector('[type=checkbox]').checked = false
							})
						},

						checkOnline() {
							$all('#contacts li').forEach(function (li) {
								li.querySelector('[type=checkbox]').checked = li.model.authorized
							})
						},

						checkOffline() {
							$all('#contacts li').forEach(function (li) {
								li.querySelector('[type=checkbox]').checked = !li.model.authorized
							})
						},

						showOnline() {
							const checkbox = $$('#showOnline [type=checkbox]')
							checkbox.checked = !checkbox.checked
							const ul = $$('#contacts ul')
							const list = ul.querySelectorAll('li')
							ul.detach()
							list.forEach(function (li) {
								li.isVisible = checkbox.checked ? li.model.authorized : true
							})
							ul.attach()
							$id('checkOnline').disabled = checkbox.checked
							$id('checkOffline').disabled = checkbox.checked
						}
					});

					$id('contacts').show()


					const elLoadContacts = $id('loadContacts')
					const elLoadContactsInformer = $id('loadContactsInformer')
					const elLoadContactsActual = elLoadContactsInformer.querySelector('.actual')
					const elLoadContactsExpected = elLoadContactsInformer.querySelector('.expected')
					elLoadContacts.addEventListener('change', function (e) {
						elLoadContacts.hide()
						const reader = new FileReader()
						reader.addEventListener('load', function (e) {
							const nicks = []
							e.target.result.split(/\s+/).forEach(function (s) {
								s = s.trim()
								if (s) {
									nicks.push(s)
								}
							})
							elLoadContactsActual.innerHTML = '0'
							elLoadContactsExpected.innerHTML = nicks.length
							multi(nicks.map(function (nick, i) {
								return function () {
									elLoadContactsActual.innerHTML = i
									return accept(account, nick)
											.then(function (data) {
												console.log(data)
											})
								}
							}))
									.then(function () {
										elLoadContactsInformer.hide()
										elLoadContacts.show()
									})
									.catch(function (err) {
										console.error(err)
									})
							elLoadContactsInformer.show()
						})
						reader.readAsText(e.target.files[0])
					})

					const elTextarea = $$('textarea')
					const sendButton = $id('send')
					sendButton.addEventListener('click', function () {
						const contacts = []
						$all('#contacts li').forEach(function (li) {
							if (li.querySelector('[type=checkbox]').checked) {
								contacts.push(li.model)
							}
						})
						multi(contacts.map(function (contact) {
							return function () {
								return send(account, contact.person_id, elTextarea.value)
										.then(function (o) {
											console.log(o)
										});
							}
						}))
					})
				})
			})
			.catch(function (err) {
				console.error(err)
			})

	$$('[type=search]').addEventListener('keyup', debounce(function (e) {
		const ul = $$('#contacts ul')
		const matches = []
		e.target.value.split(/\s+/).forEach(function (s) {
			s = s.trim()
			if (s) {
				matches.push(new RegExp(s, 'i'))
			}
		})
		function find(s) {
			return 0 === matches.length || (s && matches.every(m => m.test(s)))
		}

		const list = ul.querySelectorAll('li')
		ul.detach()
		list.forEach(function (li) {
			li.isVisible = find(li.model.display_name) || find(li.model.id)
		})
		ul.attach()
	}, 40))
</script>
</body>
</html>
